---
import { sanity } from "../../lib/sanity";
import BaseLayout from "../../layouts/BaseLayout.astro";
import ArticleGrid from "../../components/ArticleGrid.astro";

type AuthorSlug = { slug: string };

type Author = {
  name: string;
};

type Article = {
  title: string;
  slug: string;
  excerpt?: string;
  publishedAt?: string;

  // keep the same “try multiple fields” approach as section page
  mainImage?: any;
  coverImage?: any;
  image?: any;

  author?: { name: string; slug: string };
  section?: { title: string; slug: string };
};

// 1) Static paths for authors
export async function getStaticPaths() {
  const authors = await sanity.fetch<AuthorSlug[]>(
    `*[_type=="author" && defined(slug.current)]{
      "slug": slug.current
    }`
  );

  return authors.map((a) => ({
    params: { slug: a.slug },
  }));
}

const { slug } = Astro.params;

// 2) Fetch author + their articles
const data = await sanity.fetch<{
  author: Author;
  articles: Article[];
}>(
  `{
    "author": *[_type=="author" && slug.current == $slug][0]{
      name
    },
    "articles": *[
      _type=="article" &&
      author->slug.current == $slug
    ] | order(publishedAt desc){
      title,
      excerpt,
      publishedAt,
      mainImage,
      coverImage,
      image,
      "slug": slug.current,
      "author": author->{ name, "slug": slug.current },
      "section": section->{ title, "slug": slug.current }
    }
  }`,
  { slug }
);

if (!data?.author) {
  return new Response("Author not found", { status: 404 });
}
---

<BaseLayout title={data.author.name}>
  <h1>{data.author.name}</h1>

  <ArticleGrid articles={data.articles} />
</BaseLayout>

<style>
  h1 {
    text-transform: uppercase;
    text-align: center;
    border-top: 3px solid;
    border-bottom: 3px solid;
    padding: 25px 0;
  }
</style>
