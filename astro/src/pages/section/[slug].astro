---
import { sanity } from "../../lib/sanity";
import { portableTextToHtml } from "../../lib/portableText";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { urlFor } from "../../lib/sanityImage"; // same helper as index
import Pill from "../../components/Pill.astro";
import ArticleGrid from "../../components/ArticleGrid.astro";

type SectionSlug = { slug: string };

type Section = {
  title: string;
};

type Article = {
  title: string;
  slug: string;
  excerpt?: string;
  publishedAt?: string;

  // try common image field names (only one needs to exist)
  mainImage?: any;
  coverImage?: any;
  image?: any;

  author?: { name: string; slug: string };
  section?: { title: string; slug: string };
};

// 1) Static paths for sections
export async function getStaticPaths() {
  const sections = await sanity.fetch<SectionSlug[]>(
    `*[_type=="section" && defined(slug.current)]{
      "slug": slug.current
    }`
  );

  return sections.map((s) => ({
    params: { slug: s.slug },
  }));
}

const { slug } = Astro.params;

// 2) Fetch section + its articles
const data = await sanity.fetch<{
  section: Section;
  articles: Article[];
}>(
  `{
    "section": *[_type=="section" && slug.current == $slug][0]{
      title
    },
    "articles": *[
  _type=="article" &&
  section->slug.current == $slug
] | order(publishedAt desc){
  title,
  excerpt,
  publishedAt,
  mainImage,
  coverImage,
  image,
  "slug": slug.current,
  "author": author->{ name, "slug": slug.current },
  "section": section->{ title, "slug": slug.current }
}

  }`,
  { slug }
);

if (!data?.section) {
  return new Response("Section not found", { status: 404 });
}
---

<BaseLayout title={data.section.title}>
  <h1>{data.section.title}</h1>

  <ArticleGrid articles={data.articles} />
</BaseLayout>

<style>
  h1 {
    text-transform: uppercase;
    text-align: center;
    border-top: 3px solid;
    border-bottom:3px solid;
    padding: 25px 0;
  }
</style>
